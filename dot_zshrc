
### Added by Zinit's installer
if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})…%f"
    command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
        print -P "%F{33} %F{34}Installation successful.%f%b" || \
        print -P "%F{160} The clone has failed.%f%b"
fi

source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# Load a few important annexes, without Turbo
# (this is currently required for annexes)
zinit light-mode for \
    zdharma-continuum/zinit-annex-as-monitor \
    zdharma-continuum/zinit-annex-bin-gem-node \
    zdharma-continuum/zinit-annex-patch-dl \
    zdharma-continuum/zinit-annex-rust

### End of Zinit's installer chunk

export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"

export HOMEBREW_NO_ANALYTICS=1

export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_STATE_HOME="$HOME/.local/state"
export XDG_CACHE_HOME="$HOME/.cache"

function get_interface_style() {
  if defaults read -g AppleInterfaceStyle 2>/dev/null | grep -q "Dark"; then
    echo "dark";
  else
    echo "light";
  fi
}

typeset -A ZSH_HIGHLIGHT_STYLES

function update_interface_style() {
  export INTERFACE_STYLE=$(get_interface_style)

  export LS_COLORS="$(vivid generate solarized-${INTERFACE_STYLE})"

  # Update dependent variables
  if [[ $INTERFACE_STYLE == "dark" ]]; then
    ZSH_HIGHLIGHT_STYLES[comment]='fg=240'

    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=240"

    if [ -n "$TMUX" ]; then
      tmux set -g status-style bg='black'

      tmux set -g status-left "#[fg=color230,bg=color136,bold] #S #[fg=colour136,bg=black,nobold,nounderscore,noitalics] "
      tmux set -g status-right "#[fg=brightblack,bg=black,nobold,nounderscore,noitalics]#[fg=colour244,bg=brightblack] #{?window_bigger,[#{window_offset_x}#,#{window_offset_y}] ,}#{pane_current_command} in #(basename \"#{pane_current_path}\") "
      tmux setw -g window-status-format "#[fg=brightblack,bg=black,nobold,nounderscore,noitalics]#[fg=colour61,bg=brightblack] #I#F #[fg=colour37,bg=brightblack] #W #[fg=brightblack,bg=black,nobold,nounderscore,noitalics] "
      tmux setw -g window-status-current-format "#[fg=colour61,bg=black,nobold,nounderscore,noitalics]#[fg=brightcyan,bg=colour61] #I#F #[fg=colour37,bg=brightblack] #W #[fg=brightblack,bg=black,nobold,nounderscore,noitalics] "
    fi
  else
    ZSH_HIGHLIGHT_STYLES[comment]='fg=245'

    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=245"

    if [ -n "$TMUX" ]; then
      tmux set -g status-style bg='white'

      tmux set -g status-left "#[fg=color230,bg=color136,bold] #S #[fg=colour136,bg=white,nobold,nounderscore,noitalics] "
      tmux set -g status-right "#[fg=brightwhite,bg=white,nobold,nounderscore,noitalics]#[fg=brightcyan,bg=brightwhite] #{?window_bigger,[#{window_offset_x}#,#{window_offset_y}] ,}#{pane_current_command} in #(basename \"#{pane_current_path}\") "
      tmux setw -g window-status-format "#[fg=brightwhite,bg=white,nobold,nounderscore,noitalics]#[fg=colour61,bg=brightwhite] #I#F #[fg=colour37,bg=brightwhite] #W #[fg=brightwhite,bg=white,nobold,nounderscore,noitalics] "
      tmux setw -g window-status-current-format "#[fg=colour61,bg=white,nobold,nounderscore,noitalics]#[fg=brightwhite,bg=colour61] #I#F #[fg=colour37,bg=brightwhite] #W #[fg=brightwhite,bg=white,nobold,nounderscore,noitalics] "
    fi
  fi
}

update_interface_style

HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=$HISTSIZE

setopt EXTENDED_HISTORY
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_SAVE_NO_DUPS
setopt HIST_VERIFY
setopt HIST_BEEP

setopt INTERACTIVE_COMMENTS

alias k9='kill -9'

alias ls='eza --icons --group-directories-first'
alias ll='eza --icons --group-directories-first -l'

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'
alias -- -='cd -'

alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

alias _='sudo'
alias mkdir='mkdir -p'
alias sa='alias | grep -i'

alias o='open'
alias pbc='pbcopy'

# Show/hide hidden files in the Finder
alias showfiles="defaults write com.apple.finder AppleShowAllFiles -bool true && killall Finder"
alias hidefiles="defaults write com.apple.finder AppleShowAllFiles -bool false && killall Finder"

# Set up fzf key bindings and fuzzy completion
source <(fzf --zsh)

eval "$(gh copilot alias -- zsh)"

eval "$(zoxide init --cmd cd zsh)"

zinit light zsh-users/zsh-completions
zinit light Aloxaf/fzf-tab
autoload -U compinit && compinit
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
# TODO: Make the colours match the colours in eza.
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu no
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'

# Must be loaded before history-substring-search, autosuggestions, and the prompt.
zinit light zsh-users/zsh-syntax-highlighting

# Must be loaded after syntax-highlighting and before augosuggestions and the prompt.
zinit snippet OMZ::plugins/git/git.plugin.zsh
zinit load 'zsh-users/zsh-history-substring-search'
# zinit ice wait atload"_history_substring_search_config"
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey -M emacs '^P' history-substring-search-up
bindkey -M emacs '^N' history-substring-search-down
bindkey -M vicmd 'k' history-substring-search-up
bindkey -M vicmd 'j' history-substring-search-down

# Must be loaded after syntax-highlighting, history-substring-search, and the prompt.
zinit light zsh-users/zsh-autosuggestions

zinit load 'djui/alias-tips'

zinit snippet OMZP::dotenv
zinit snippet OMZP::encode64
zinit snippet OMZP::man
zinit snippet OMZP::thefuck
zinit snippet OMZP::tldr
# zinit snippet OMZP::vi-mode

# Makes a directory and changes to it.
function mkdcd {
  [[ -n "$1" ]] && mkdir -p "$1" && builtin cd "$1"
}

# Changes to a directory and lists its contents.
function cdls {
  builtin cd "$argv[-1]" && ls "${(@)argv[1,-2]}"
}

# Deletes .DS_Store and __MACOSX directories.
function osx-rm-dir-metadata {
  find "${@:-$PWD}" \( \
    -type f -name '.DS_Store' -o \
    -type d -name '__MACOSX' \
  \) -print0 | xargs -0 rm -rf
}

# Hook into Zsh's `precmd` to check and update the interface style before each prompt
precmd_functions+=(update_interface_style)

if [ "$TERM_PROGRAM" != "Apple_Terminal" ]; then
  eval "$(oh-my-posh init zsh --config ~/.config/ohmyposh/base.json)"

  function set_poshcontext() {
    export INTERFACE_STYLE=$(get_interface_style)
  }
fi

ZSH_HIGHLIGHT_STYLES[reserved-word]='fg=green'
ZSH_HIGHLIGHT_STYLES[builtin]='fg=166'
ZSH_HIGHLIGHT_STYLES[function]='fg=yellow'
ZSH_HIGHLIGHT_STYLES[command]='fg=yellow'
ZSH_HIGHLIGHT_STYLES[path]='fg=blue,underline'
ZSH_HIGHLIGHT_STYLES[single-hyphen-option]='fg=61'
ZSH_HIGHLIGHT_STYLES[double-hyphen-option]='fg=61'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument]='fg=cyan'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument-delimiter]='fg=cyan'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument-unclosed]='fg=red,underline'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument]='fg=cyan'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument-unclosed]='fg=red,underline'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument]='fg=cyan'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument-unclosed]='fg=red,underline'

# Homebrew Command Not Found
HB_CNF_HANDLER="$(brew --repository)/Library/Taps/homebrew/homebrew-command-not-found/handler.sh"
if [ -f "$HB_CNF_HANDLER" ]; then
  source "$HB_CNF_HANDLER";
fi
